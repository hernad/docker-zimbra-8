#!/bin/bash

source /init/init-common


cp -av /docker_etc/etc/* /etc/

if  [ ! -f /opt/zimbra/conf/my.cnf ] ; then
  cp -av /docker_etc/conf/* /opt/zimbra/conf/
fi

cp -av /docker_etc/common_conf/* /opt/zimbra/common/conf/
cp -av /docker_etc/common_etc/* /opt/zimbra/common/etc/

cd /
echo "extract instance configuration created during create instance phase:"
echo "   /opt/zimbra/jetty_base, logger, zimbra_ssh, spamassassin, cache_debconf tars"
tar xf /docker_etc/jetty_base.tar.gz
tar xf /docker_etc/logger.tar.gz
tar xf /docker_etc/zimbra_ssh.tar.gz
tar xf /docker_etc/zimbra_saveconfig.tar.gz
tar xf /docker_etc/spamassassin.tar.gz
tar xf /docker_etc/cache_debconf.tar.gz
tar xf /docker_etc/etc_ssh.tar.gz

fix_zimbra_priviledges

service ssh start
service ssh status

chmod g+w /opt/zimbra/common/conf

su - zimbra -c "/opt/zimbra/bin/zmcontrol start"


echo "zimbra version:"
su - zimbra -c "zmprov getServer ${ZIMBRA_HOST_NAME} zimbraServerVersion"

ZIMBRA_RESTART=0
ZIMLET=tk_barrydegraaff_account_history  
if  !  su - zimbra -c "zmzimletctl info $ZIMLET" ; then
  su - zimbra -c "zmzimletctl deploy /opt/zimbra/zimlets/$ZIMLET.zip"
  ZIMBRA_RESTART=1
fi

ZIMLET=tk_barrydegraaff_accounthistory_admin  
if  !  su - zimbra -c "zmzimletctl info $ZIMLET" ; then
  su - zimbra -c "zmzimletctl deploy /opt/zimbra/zimlets/$ZIMLET.zip"
  ZIMBRA_RESTART=1
fi

if [ "$ZIMBRA_RESTART" == "1" ] ; then
  su - zimbra -c "zmcontrol restart"
fi


# https://github.com/Zimbra-Community/account-history#log-external-ip
su - zimbra -c "zmlocalconfig zimbra_http_originating_ip_header"
su - zimbra -c "zimbra_http_originating_ip_header = X-Forwarded-For"
su - zimbra -c "zmprov mcf +zimbraMailTrustedIP 127.0.0.1"

su - zimbra -c "/init/antispam_setup"

echo "===RUN_END=="
tail -f /dev/null
