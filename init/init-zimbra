#!/bin/bash
source /init/init-common

echo "/opt/zimbra/conf_0 - conf volume"
rm -rf /opt/zimbra/conf/*

for dir in conf db/data log store ssl data/clamav data/postfix data/ldap logger zimlets-deployed
do
  echo chown -R zimbra:zimbra /opt/zimbra/$dir
  chown -R zimbra:zimbra /opt/zimbra/$dir
done

mv /opt/zimbra/conf_0/* /opt/zimbra/conf/

# NOTE: Currently genesis tests assume that the zmhostname == zimbra_default_domain
#       A fix for this is in progress
zimbra_fqdn=${ZIMBRA_HOST_NAME}
update_host_entry ${zimbra_fqdn}
update_tzdata_config
update_zmsetup_config_file

# Configure Zimbra
/opt/zimbra/libexec/zmsetup.pl -c /init/config
echo "Enable admin access via proxy. Required for SOAP Harness tests "
sudo -i -u zimbra /opt/zimbra/libexec/zmproxyconfig -e -w -C -H ${ZIMBRA_HOST_NAME}
echo "Disable max imap/pop3 max error limits. Required for Genesis"
sudo -i -u zimbra zmlocalconfig -e imap_max_consecutive_error=0 pop3_max_consecutive_error=0
post_zmsetup_configuration 
configure_staf 


echo '/etc -> /docker_etc'
cp -av /etc/hosts /etc/aliases.lmdb /etc/localtime /etc/timezone /docker_etc
mkdir /docker_etc/logrotate.d
cp -av /etc/logrotate.d/zimbra  /docker_etc/logrotate.d/
mkdir /docker_etc/rsyslog.d
cp -av /etc/rsyslog.d/50-default.conf /etc/rsyslog.d/60-zimbra.conf /docker_etc/rsyslog.d


echo "SETUP COMPLETE"
/bin/sleep infinity

